<!DOCTYPE html>
<!-- saved from url=(0483)http://cache.baiducontent.com/c?m=mcfEJh7RFRjfXx-1MaisCOPwfl_C7lE3OGE7d5zxhv0KJatpnWetxT43MYZMAvJTuhGvnrTngY3QSdIlyqIcsIp8atm8sbN1uJ468wyQoVeBsvzMdheUe8NtdIuUF0hg4ZSiC-tGyP5zMBTPO4-5HfmqA-ArqtfZbYvLoTIQYJdqs4IQwAdWRpBIc986gWWA&p=8b2a971d93dd15fe04bd9b7f1b&newp=87769a47808a1ffe01bd9b7f4253d8224216ed643ad4c44324b9d71fd325001c1b69e6b922241300d7c07b6c0bac4d58e1f33278341766dada9fca458ae7c47e66d6766d&s=ad61ab143223efbc&user=baidu&fm=sc&query=mmc%5Fpower%5Fup&qid=cae403d500016348&p1=16 -->
<html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=GBK">
<!--<base href="http://www.360doc.com/content/13/0403/10/6973384%5F275679840.shtml">--><base href=".">
<style>
body{position:relative}
body,form{margin:0!important;padding:0!important}
#bd_snap{font:13px arial;color:#000;background:#fff;text-align:left;padding:13px 0 0 20px}
#bd_snap_txt{clear:both;padding:10px 0 2px;line-height:24px;color:#333}
#bd_snap_note{color:#999;padding-bottom:10px}
#bd_snap a{font:13px arial;color:#00c;text-decoration:underline}
#bd_snap_note a{color:#999}
#bd_snap_head{width:860px;height:44px}
#bd_snap_logo{width:162px;height:38px;display:block;background:url(http://www.baidu.com/img/logo-snap.png) no-repeat;margin-right:15px;float:left}
#bd_snap_search{width:680px;position:absolute;left:209px;top:17px}
#bd_snap_kw{width:531px;margin-right: 0;height:24px;padding:4px 7px;padding:6px 7px 2px\9;font:16px arial;vertical-align:top;border: 1px solid #b6b6b6;border-color: #7b7b7b #b6b6b6 #b6b6b6 #7b7b7b;background: #fff;display:inline-block;border-right-width: 0;border-color: #b8b8b8 transparent #ccc #b8b8b8;overflow: hidden;outline:0}
#bd_snap_kw:hover{border-color: #999 transparent #b3b3b3 #999;}
#bd_snap_kw:focus{border-color: #4791ff transparent #4791ff #4791ff}
#bd_snap_su{width:100px;height:34px;font-size:14px;color:#fff;padding:0;letter-spacing: 1px;background: #3385ff; border-bottom: 1px solid #2d78f4;outline: medium;-webkit-appearance: none;-webkit-border-radius: 0;cursor:pointer;border:0}
#bd_snap_search input.bd_snap_btn_h{background: #3075dc;box-shadow: inset 1px 1px 3px #2964bb;-webkit-box-shadow: inset 1px 1px 3px #2964bb;-moz-box-shadow: inset 1px 1px 3px #2964bb;-o-box-shadow: inset 1px 1px 3px #2964bb;}
#bd_snap_search input.btnhover{background: #317ef3;border-bottom: 1px solid #2868c8;box-shadow: 1px 1px 1px #ccc;}
#bd_snap_btn_wr{width:97px;height:34px;display:inline-block;_top:1px;*position:relative}
#bd_snap_ln{height:1px;border-top:1px solid #ACA899;background:#ECE9D8;overflow:hidden}
#bd_snap_txt span a{text-decoration:none}
</style>


</head><body onmouseup="setDragEnd()" onmousemove="DragDiv();" onclick="delAllDiv(event)"><div id="bd_snap">
    <div id="bd_snap_head">
        <a href="http://www.baidu.com/" id="bd_snap_logo" title="到百度首页"></a>
    </div>
    <div id="bd_snap_txt">您查询的关键词是：<span><a style="color:black;background-color:#ffff66;padding:0 3px;font-weight:bold" href="http://cache.baiducontent.com/c?m=mcfEJh7RFRjfXx-1MaisCOPwfl_C7lE3OGE7d5zxhv0KJatpnWetxT43MYZMAvJTuhGvnrTngY3QSdIlyqIcsIp8atm8sbN1uJ468wyQoVeBsvzMdheUe8NtdIuUF0hg4ZSiC-tGyP5zMBTPO4-5HfmqA-ArqtfZbYvLoTIQYJdqs4IQwAdWRpBIc986gWWA&amp;p=8b2a971d93dd15fe04bd9b7f1b&amp;newp=87769a47808a1ffe01bd9b7f4253d8224216ed643ad4c44324b9d71fd325001c1b69e6b922241300d7c07b6c0bac4d58e1f33278341766dada9fca458ae7c47e66d6766d&amp;s=ad61ab143223efbc&amp;user=baidu&amp;fm=sc&amp;query=mmc%5Fpower%5Fup&amp;qid=cae403d500016348&amp;p1=16#baidusnap0">mmc_power_up</a></span>  
        <p>如果打开速度慢，可以尝试<a href="http://cache.baiducontent.com/c?m=mcfEJh7RFRjfXx-1MaisCOPwfl_C7lE3OGE7d5zxhv0KJatpnWetxT43MYZMAvJTuhGvnrTngY3QSdIlyqIcsIp8atm8sbN1uJ468wyQoVeBsvzMdheUe8NtdIuUF0hg4ZSiC-tGyP5zMBTPO4-5HfmqA-ArqtfZbYvLoTIQYJdqs4IQwAdWRpBIc986gWWA&amp;p=8b2a971d93dd15fe04bd9b7f1b&amp;newp=87769a47808a1ffe01bd9b7f4253d8224216ed643ad4c44324b9d71fd325001c1b69e6b922241300d7c07b6c0bac4d58e1f33278341766dada9fca458ae7c47e66d6766d&amp;s=ad61ab143223efbc&amp;user=baidu&amp;fm=sc&amp;query=mmc%5Fpower%5Fup&amp;qid=cae403d500016348&amp;p1=16&amp;fast=y">快速版</a>；如果想更新或删除快照，可以<a href="http://help.baidu.com/newadd?prod_id=1&amp;category=1&amp;link=http%3A%2F%2Fcache.baiducontent.com%2Fc%3Fm%3DmcfEJh7RFRjfXx-1MaisCOPwfl_C7lE3OGE7d5zxhv0KJatpnWetxT43MYZMAvJTuhGvnrTngY3QSdIlyqIcsIp8atm8sbN1uJ468wyQoVeBsvzMdheUe8NtdIuUF0hg4ZSiC-tGyP5zMBTPO4-5HfmqA-ArqtfZbYvLoTIQYJdqs4IQwAdWRpBIc986gWWA%26p%3D8b2a971d93dd15fe04bd9b7f1b%26newp%3D87769a47808a1ffe01bd9b7f4253d8224216ed643ad4c44324b9d71fd325001c1b69e6b922241300d7c07b6c0bac4d58e1f33278341766dada9fca458ae7c47e66d6766d%26s%3Dad61ab143223efbc%26user%3Dbaidu%26fm%3Dsc%26query%3Dmmc%255Fpower%255Fup%26qid%3Dcae403d500016348%26p1%3D16" id="bd_tousu">投诉快照</a>。
        </p>
    </div>
<script>document.getElementById('bd_tousu').href = 'http://help.baidu.com/newadd?prod_id=1&category=1&link=' + encodeURIComponent(document.location);</script>
    <div id="bd_snap_note">百度和网页 <a href="http://www.360doc.com/content/13/0403/10/6973384_275679840.shtml">http://www.360doc.com/content/13/0403/10/6973384%5F275679840.shtml</a> 的作者无关，不对其内容负责。百度快照谨为网络故障时之索引，不代表被搜索网站的即时页面。</div>
</div>
<div id="bd_snap_search">
	<form action="http://www.baidu.com/s"><input name="cl" type="hidden" value="3"><input name="wd" id="bd_snap_kw" maxlength="100"><span id="bd_snap_btn_wr"><input type="submit" id="bd_snap_su" value="百度一下" class="bd_snap_btn" onmouseover="this.className=&#39;bd_snap_btn bd_snap_btn_h&#39;" onmousedown="this.className=&#39;bd_snap_btn btnhover&#39;" onmouseup="this.className=&#39;bd_snap_btn&#39;" onmouseout="this.className=&#39;bd_snap_btn&#39;"></span></form>
</div>
<div id="bd_snap_ln"></div>
<div style="position:relative">






    
    <meta http-equiv="X-UA-Compatible" content="IE=EmulateIE7">
    
    <meta content="360doc" name="classification">
    
    <link rel="alternate" media="only screen and (max-width: 640px)" href="http://www.360doc.cn/article/6973384_275679840.html">
    <meta content="SD卡操作" name="keywords">
    <meta content="SD卡操作" name="description">
    <meta name="mobile-agent" content="format=html5;url=http://www.360doc.cn/article/6973384_275679840.html">
    <meta content="www.360doc.com" name="author">
    
    <title>
        SD卡操作
    </title>
    
    
    
    
    <link href="./SD卡操作_files/wz.css" rel="stylesheet" type="text/css">


    


    <div class="containera">
        <div class="headersmall">
            <div class="helpsmall">
                <div class="help1 julink">
                    <span><a href="http://www.360doc.com/help.html" target="_blank">帮助</a></span><span>|</span><span><a target="_blank" href="http://www.360doc.com/advice.html">留言交流</a></span><span>|</span>
                    <span id="spanLogin">
                        <span id="loginstatus"></span>
                    </span>
                </div>
            </div>
        </div>
    </div>

    <div class="logebox">
        <div class="logemain">
            <div class="logeimg left">
                <img src="./SD卡操作_files/logo2.gif">
            </div>
            <div class=" left" style="padding-top: 27px;">
                <table border="0" cellpadding="0" cellspacing="0" height="24">
                    <tbody>
                        <tr>
                            <td width="70px"></td>
                            <td class="navwz" width="88px">
                                <a href="http://www.360doc.com/index.html">首&nbsp;页</a>
                            </td>
                            <td class="navwz" width="120px">
                                <a href="http://www.360doc.com/readroom.html">阅览室</a>

                            </td>
                            <td class="navwz" width="94px">
                                <a href="http://www.360doc.com/weekstar.html">馆友</a>
                            </td>
                            <td class="navwz" width="152px">
                                <a href="http://www.360doc.com/my360doc.aspx">我的图书馆</a>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="right search">
                <div class=" left">
                    <img src="./SD卡操作_files/tb2.gif">
                </div>
                <div class=" left">
                    <input name="input" class="scinput" onkeyup="showIntelliSense()" id="txtSearchword" value="  搜文章 找馆友" onblur="if(!this.value) {this.value=&#39;  搜文章 找馆友&#39;;this.style.color=&#39;#b2b2b2&#39;;}" onfocus="if(this.value==&#39;  搜文章 找馆友&#39;) this.value=&#39;&#39;;this.style.color=&#39;#272727&#39;" type="text">
                </div>
                <div class=" left">
                    <a href="javascript:gosearch();">
                        <img src="./SD卡操作_files/tb3.gif" width="68" height="25"></a>
                </div>

            </div>
        </div>
    </div>
    <div class="navxt both"></div>
    <div class="both"></div>
    <div class="mainzt">
        <table class="index_main" border="0" cellpadding="0" cellspacing="0">
            <tbody>
                <tr>
                    <td align="left" valign="top" width="727px">
                        <div id="ADAboveArtContent"></div>
                        <div style="height: 7px;"></div>
                        <table border="0" cellpadding="0" cellspacing="0" class="mainbj" id="docArtClass">
                            <tbody>
                                <tr>
                                    <td>
                                        <div style="padding-top: 8px; color: #797b7a; padding-left: 6px;">
                                            <div class=" left">来自：<span class="name" onclick="wzhit(1)"><a href="http://www.360doc.com/userhome/6973384" target="_blank">cz81</a></span> &gt; <span><a href="http://www.360doc.com/userhome.aspx?userid=6973384&amp;cid=1" target="_blank">馆藏分类</a></span></div>

                                            <div class=" right">
                                                <table border="0" cellpadding="0" cellspacing="0" style="vertical-align: text-bottom;">
                                                    <tbody>
                                                        <tr>
                                                            <td width="40">配色：</td>
                                                            <td width="21">
                                                                <img src="./SD卡操作_files/cr1.gif" id="docArtC1" onclick="ChangeArtClass(1,this)" style="cursor: pointer;"></td>
                                                            <td width="21">
                                                                <img src="./SD卡操作_files/cr2.gif" id="docArtC2" onclick="ChangeArtClass(2,this)" style="cursor: pointer;"></td>
                                                            <td width="21">
                                                                <img src="./SD卡操作_files/cr3.gif" id="docArtC3" onclick="ChangeArtClass(3,this)" style="cursor: pointer;"></td>
                                                            <td width="21">
                                                                <img src="./SD卡操作_files/cr4.gif" id="docArtC4" onclick="ChangeArtClass(4,this)" style="cursor: pointer;"></td>
                                                            <td width="21">
                                                                <img src="./SD卡操作_files/cr5.gif" id="docArtC5" onclick="ChangeArtClass(5,this)" style="cursor: pointer;"></td>
                                                            <td width="28">
                                                                <img src="./SD卡操作_files/cr6.gif" id="docArtC6" onclick="ChangeArtClass(6,this)" style="cursor: pointer;"></td>
                                                            <td width="95" class="zihao">字号：<span style="cursor: pointer;" onclick="ChangeArtSize(3,this)">大</span><span style="cursor: pointer;" onclick="ChangeArtSize(2,this)">中</span><span style="cursor: pointer;" onclick="ChangeArtSize(1,this)">小</span></td>
                                                        </tr>
                                                    </tbody>
                                                </table>

                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <table border="0" cellpadding="0" cellspacing="0" style="width: 100%; text-align: center;">
                                            <tbody>
                                                <tr>
                                                    <td class="biaoti">SD卡操作</td>
                                                </tr>
                                                <tr>
                                                    <td class="biaoqian">


                                                        <table cellpadding="0" cellspacing="0" style="text-align: center; margin: 0px auto;">
                                                            <tbody>
                                                                <tr>
                                                                    <td>


                                                                        <div class="left">2013-04-03&nbsp;|&nbsp;阅：<span id="360doc_Readnum"></span>&nbsp;&nbsp;转：<span id="360doc_saverNum"></span>&nbsp;&nbsp;|&nbsp;&nbsp;<a href="http://www.360doc.com/content/13/0403/10/6973384_275679840.shtml#" onclick=" setTimeout(showShareLayer, 10);">分享</a>&nbsp;</div>

                                                                        <div class="left">
                                                                            <div style="padding-top: 3px;">
                                                                                <img style="cursor: pointer;" src="./SD卡操作_files/tb10.gif" onclick="  setTimeout(showShareLayer, 10);">
                                                                            </div>

                                                                            <div class="fenxiang" id="fenxiangLayer" style="display: none;">
                                                                            </div>
                                                                            <div id="AlertArt1" style="display: none; position: absolute;"></div>
                                                                            <div id="SendToFriends1" style="display: none; position: absolute;"></div>
                                                                            <div id="resavelayer1" class="left zcbutton"></div>
                                                                        </div>

                                                                        <div class="left">&nbsp;&nbsp;<span id="savestatus"></span></div>


                                                                    </td>
                                                                </tr>
                                                            </tbody>
                                                        </table>



                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td>
                                                        <table class="wenzhangcss" border="0" cellpadding="0" cellspacing="0" width="100%">
                                                            <tbody>
                                                                <tr>
                                                                    <td style="height: 29px;">
                                                                        <div class="xiantao"></div>
                                                                    </td>
                                                                </tr>
                                                                <tr>
                                                                    <td align="left" valign="top" width="670px" style="height: 200px;">
                                                                           
                                                                        <span id="articlecontent" onmouseup="NewHighlight(event)">
                                                                            <table>
                                                                                <tbody>
                                                                                    <tr>
                                                                                        <td width="670px">我的内核是linux 2.6.28，已经带有了sd 
mmc卡驱动了只要在menuconfig里面把相应选项选上即可， 
<div>编译出来了之后，我插上了我的一个512mb的卡，在启动信息了打印如下：</div>
<div><br>s3c2440-sdi s3c2440-sdi: powered 
down.<br><span style="COLOR: #ff0000">mmc0: error -110 whilst initialising SD 
card</span><br>s3c2440-sdi s3c2440-sdi: powered down.</div>
<div></div>
<div>注意红色部分，进入了之后/dev/devices 
里面看不到没有相应的驱动。驱动工作不正常！</div>
<div></div>
<div>但是插上了一个32mb的卡后，就能够正常识别。</div>
<div>在网上查到如下信息：</div>
<div></div>
<div><span style="COLOR: #0099cc">mmc0: error -110 
whilst initialising SD card <br>应该是卡在 linux/driver/mmc/core/sd.c 的 
<br>mmc_sd_init_card() --&gt; mmc_send_app_op_cond(host, ocr, NULL) <br><br>ocr 
是指 card 内部的 Operation Condition Register (OCR) 读出来的值 <br>发送 CMD41 CMD55 读取 OCR 
的值 <br>问题是出在 OCR[31] 一直是 0 &lt;--- 初始化没有完成？？ <br>结果问题是出在电压不足，要把 sd power 
enable</span> </div>
<div></div>
<div><img alt="" src="./SD卡操作_files/31380772_1.gif">上面这位说的解决方法我也不太清楚，不过他指出的错误地方是正确的，就是在那里出错的。</div>
<div></div>
<div>现在说下这个错误的解决方案：</div>
<div></div>
<div>driver/mmc/core/sd.c 
的mmc_sd_init_card()函数中mmc_read_switch前延时10ms<br><br>mdelay(10);<br><br>err 
= mmc_read_switch(card);</div>
<div></div>
<div>看到红色语句了么，就这个加上去就可以了啊，哈哈......</div>
<div></div>
<div>加上红色延时语句之后启动信息如下</div>
<div></div>
<div>s3c2440-sdi s3c2440-sdi: running at 196kHz 
(requested: 195kHz).<br>s3c2440-sdi s3c2440-sdi: running at 25000kHz (requested: 
25000kHz).<br>s3c2440-sdi s3c2440-sdi: running at 25000kHz (requested: 
25000kHz).<br><span style="color: rgb(0, 0, 255); ">mmc0: new SD 
card at address 95b9<br>mmcblk0: mmc0:95b9 SD02G 1.83 GiB<br>mmcblk0: 
p1</span></div>
<p>驱动工作完全正常。</p>
<p>进入系统后</p>
<p sizcache="0" sizset="32">mount /dev/mmcblk0p1 /mnt</p><p sizcache="0" sizset="32"><strong><em>初始化：<br></em></strong><span style="FONT-SIZE: 12pt"><span style="FONT-FAMILY: Times New Roman"><span style="COLOR: #000000">1、</span></span><span style="COLOR: #000000"><span style="FONT-FAMILY: 宋体"><span style="FONT-SIZE: 12pt">初始化读写</span></span><span style="FONT-SIZE: 12pt"><span style="FONT-FAMILY: Times New Roman">SD</span></span><span style="FONT-FAMILY: 宋体"><span style="FONT-SIZE: 12pt">卡的硬件条件（</span></span><span style="FONT-SIZE: 12pt"><span style="FONT-FAMILY: Times New Roman">spi</span></span><span style="FONT-FAMILY: 宋体"><span style="FONT-SIZE: 12pt">接口和其他有用的管腿，如写保护）</span></span></span></span><br><span style="COLOR: #000000"><span style="FONT-SIZE: 12pt"><span style="FONT-FAMILY: Times New Roman">2、</span></span><span style="FONT-FAMILY: 宋体"><span style="FONT-SIZE: 12pt">上电延时过程</span></span></span><br><span style="COLOR: #000000"><span style="FONT-SIZE: 12pt"><span style="FONT-FAMILY: Times New Roman">3、</span></span><span style="FONT-FAMILY: 宋体"><span style="FONT-SIZE: 12pt">复位卡</span></span><span style="FONT-SIZE: 12pt"><span style="FONT-FAMILY: Times New Roman"><strong>CMD0</strong></span></span></span><br><span style="COLOR: #000000"><span style="FONT-SIZE: 12pt"><span style="FONT-FAMILY: Times New Roman">4、</span></span><span style="FONT-FAMILY: 宋体"><span style="FONT-SIZE: 12pt">激活卡，内部初始化<strong>并获取存储卡的类型</strong></span></span><span style="FONT-FAMILY: Times New Roman"><strong><span style="FONT-SIZE: 12pt"><br>&nbsp; 
&nbsp;&nbsp;&nbsp;CMD1,CMD55,ACMD41</span></strong></span></span><br><span style="COLOR: #000000"><span style="FONT-SIZE: 12pt"><span style="FONT-FAMILY: Times New Roman">5、</span></span><span style="FONT-FAMILY: 宋体"><span style="FONT-SIZE: 12pt">查询</span></span><span style="FONT-SIZE: 12pt"><span style="FONT-FAMILY: Times New Roman">OCR</span></span><span style="FONT-FAMILY: 宋体"><span style="FONT-SIZE: 12pt">，获取卡供电情况</span></span><span style="FONT-SIZE: 12pt"><span style="FONT-FAMILY: Times New Roman"><strong>CMD58</strong></span></span></span><br><span style="COLOR: #000000"><span style="FONT-SIZE: 12pt"><span style="FONT-FAMILY: Times New Roman">6、</span></span><span style="FONT-FAMILY: 宋体"><span style="FONT-SIZE: 12pt">是否使用</span></span><span style="FONT-SIZE: 12pt"><span style="FONT-FAMILY: Times New Roman">CRC&nbsp; &nbsp; 
<strong>CMD59</strong></span></span></span><br><span style="COLOR: #000000"><span style="FONT-SIZE: 12pt"><span style="FONT-FAMILY: Times New Roman">7、</span></span><span style="FONT-FAMILY: 宋体"><span style="FONT-SIZE: 12pt">设置读、写块数据长度，</span></span><span style="FONT-SIZE: 12pt"><span style="FONT-FAMILY: Times New Roman">512B</span></span><span style="FONT-FAMILY: 宋体"><span style="FONT-SIZE: 12pt">，</span></span><span style="FONT-SIZE: 12pt"><span style="FONT-FAMILY: Times New Roman"><strong>CMD16</strong></span></span></span><br><span style="COLOR: #000000"><span style="FONT-SIZE: 12pt"><span style="FONT-FAMILY: Times New Roman">8、</span></span><span style="FONT-FAMILY: 宋体"><span style="FONT-SIZE: 12pt">读取</span></span><span style="FONT-SIZE: 12pt"><span style="FONT-FAMILY: Times New Roman">CSD</span></span><span style="FONT-FAMILY: 宋体"><span style="FONT-SIZE: 12pt">，<strong>获取存储卡的其他参数信息</strong>。</span></span><span style="FONT-FAMILY: Times New Roman"><strong><span style="FONT-SIZE: 12pt">CMD9</span></strong></span></span><br><span style="COLOR: #000000"><span style="FONT-SIZE: 12pt"><span style="FONT-FAMILY: Times New Roman">9、 8clock</span></span><span style="FONT-FAMILY: 宋体"><span style="FONT-SIZE: 12pt">后，禁止片选。</span></span></span><a href="http://www.rosoo.net/tags.php?/SD%BF%A8%B2%D9%D7%F7/"><br><br></a><span style="COLOR: #000000"><span style="FONT-FAMILY: 宋体"><span style="FONT-SIZE: 12pt"><a href="http://www.rosoo.net/tags.php?/SD%BF%A8%B2%D9%D7%F7/"><br><span style="COLOR: blue"><span style="FONT-SIZE: 12pt"><strong><em>读取单块数据</em></strong></span></span><br><span style="FONT-SIZE: 12pt"><span style="FONT-FAMILY: Times New Roman">1、</span></span><span style="FONT-SIZE: 12pt">主机发送</span><span style="FONT-FAMILY: Times New Roman"><strong><span style="FONT-SIZE: 12pt">CMD17</span></strong></span><br></a><span style="FONT-SIZE: 12pt"><span style="FONT-FAMILY: Times New Roman">2、</span></span><span style="FONT-SIZE: 12pt">接收卡响应</span><span style="FONT-SIZE: 12pt"><span style="FONT-FAMILY: Times New Roman">R1</span></span><a href="http://www.rosoo.net/tags.php?/SD%BF%A8%B2%D9%D7%F7/"><br><span style="FONT-SIZE: 12pt"><span style="FONT-FAMILY: Times New Roman">3、</span></span><span style="FONT-SIZE: 12pt">接收读数据起始令牌</span><span style="FONT-SIZE: 12pt"><span style="FONT-FAMILY: Times New Roman">0xFE</span></span><br><span style="FONT-SIZE: 12pt"><span style="FONT-FAMILY: Times New Roman">4、</span></span><span style="FONT-SIZE: 12pt">接收数据</span><br><span style="FONT-SIZE: 12pt"><span style="FONT-FAMILY: Times New Roman">5、</span></span><span style="FONT-SIZE: 12pt">接收</span><span style="FONT-SIZE: 12pt"><span style="FONT-FAMILY: Times New Roman">2B 
CRC</span></span><br><span style="FONT-SIZE: 12pt"><span style="FONT-FAMILY: Times New Roman">6 、8clock</span></span><span style="FONT-SIZE: 12pt">后，禁止片选。</span><br><br><span style="COLOR: blue"><span style="FONT-SIZE: 12pt"><strong><em>写入单块数据</em></strong></span></span><br><span style="FONT-SIZE: 12pt"><span style="FONT-FAMILY: Times New Roman">1、</span></span><span style="FONT-SIZE: 12pt">主机发送</span><span style="FONT-FAMILY: Times New Roman"><strong><span style="FONT-SIZE: 12pt">CMD24</span></strong></span><br><span style="FONT-SIZE: 12pt"><span style="FONT-FAMILY: Times New Roman">2、</span></span><span style="FONT-SIZE: 12pt">接收卡响应</span><span style="FONT-SIZE: 12pt"><span style="FONT-FAMILY: Times New Roman">R1</span></span><br><span style="FONT-SIZE: 12pt"><span style="FONT-FAMILY: Times New Roman">3、</span></span><span style="FONT-SIZE: 12pt">接收读数据起始令牌</span><span style="FONT-SIZE: 12pt"><span style="FONT-FAMILY: Times New Roman">0xFE</span></span><br><span style="FONT-SIZE: 12pt"><span style="FONT-FAMILY: Times New Roman">4、</span></span><span style="FONT-SIZE: 12pt">接收数据</span><br><span style="FONT-SIZE: 12pt"><span style="FONT-FAMILY: Times New Roman">5、</span></span><span style="FONT-SIZE: 12pt">接收</span><span style="FONT-SIZE: 12pt"><span style="FONT-FAMILY: Times New Roman">2B 
CRC</span></span><br><span style="FONT-SIZE: 12pt"><span style="FONT-FAMILY: Times New Roman">6 、8clock</span></span><span style="FONT-SIZE: 12pt">后，禁止片选。</span></a></span></span></span></p>
<p>&nbsp;</p>
<div style="LINE-HEIGHT: 1.3" id="detail" class="detail">
<p>
</p><p style="line-height: 21px; margin-top: 0cm; margin-right: 0cm; margin-bottom: 0pt; margin-left: 0cm; font-family: Arial, Helvetica, simsun, u5b8bu4f53; color: rgb(149, 149, 149); "><span style="LINE-HEIGHT: 25px">SD卡调试关键点：</span></p><br style="line-height: 25px; font-family: Arial, Helvetica, simsun, u5b8bu4f53; color: rgb(149, 149, 149); ">
<p style="line-height: 21px; text-indent: -18pt; margin-top: 0cm; margin-right: 0cm; margin-bottom: 0pt; margin-left: 18pt; font-family: Arial, Helvetica, simsun, u5b8bu4f53; color: rgb(149, 149, 149); "><span style="LINE-HEIGHT: 25px">1.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="LINE-HEIGHT: 25px">上电时要延时足够长的时间给</span><span style="LINE-HEIGHT: 24px; FONT-SIZE: 12pt">SD</span><span style="LINE-HEIGHT: 25px">卡一个准备过程，在我的程序里是</span><span style="LINE-HEIGHT: 24px; FONT-SIZE: 12pt">5</span><span style="LINE-HEIGHT: 25px">秒，根据不同的卡设置不同的延时时间。</span><span style="LINE-HEIGHT: 24px; FONT-SIZE: 12pt">SD</span><span style="LINE-HEIGHT: 25px">卡初始化第一步在发送</span><span style="LINE-HEIGHT: 24px; FONT-SIZE: 12pt">CMD</span><span style="LINE-HEIGHT: 25px">命令之前，在片选有效的情况下首先要发送至少</span><span style="LINE-HEIGHT: 24px; FONT-SIZE: 12pt">74</span><span style="LINE-HEIGHT: 25px">个时钟，否则将有可能出现</span><span style="LINE-HEIGHT: 24px; FONT-SIZE: 12pt">SD</span><span style="LINE-HEIGHT: 25px">卡不能初始化的问题。</span></p><br style="line-height: 25px; font-family: Arial, Helvetica, simsun, u5b8bu4f53; color: rgb(149, 149, 149); ">
<p style="line-height: 21px; text-indent: -17.85pt; margin-top: 0cm; margin-right: 0cm; margin-bottom: 0pt; margin-left: 17.85pt; font-family: Arial, Helvetica, simsun, u5b8bu4f53; color: rgb(149, 149, 149); "><span style="LINE-HEIGHT: 25px">2.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="LINE-HEIGHT: 24px; FONT-SIZE: 12pt">SD</span><span style="LINE-HEIGHT: 25px">卡发送复位命令</span><span style="LINE-HEIGHT: 24px; FONT-SIZE: 12pt">CMD0</span><span style="LINE-HEIGHT: 25px">后，要发送版本查询命令</span><span style="LINE-HEIGHT: 24px; FONT-SIZE: 12pt">CMD8</span><span style="LINE-HEIGHT: 25px">，返回状态一般分两种，若返回</span><span style="LINE-HEIGHT: 24px; FONT-SIZE: 12pt">0x01</span><span style="LINE-HEIGHT: 25px">表示此</span><span style="LINE-HEIGHT: 24px; FONT-SIZE: 12pt">SD</span><span style="LINE-HEIGHT: 25px">卡接受</span><span style="LINE-HEIGHT: 24px; FONT-SIZE: 12pt">CMD8,</span><span style="LINE-HEIGHT: 25px">也就是说此</span><span style="LINE-HEIGHT: 24px; FONT-SIZE: 12pt">SD</span><span style="LINE-HEIGHT: 25px">卡支持版本</span><span style="LINE-HEIGHT: 24px; FONT-SIZE: 12pt">2</span><span style="LINE-HEIGHT: 25px">；若返回</span><span style="LINE-HEIGHT: 24px; FONT-SIZE: 12pt">0x05</span><span style="LINE-HEIGHT: 25px">则表示此</span><span style="LINE-HEIGHT: 24px; FONT-SIZE: 12pt">SD</span><span style="LINE-HEIGHT: 25px">卡支持版本</span><span style="LINE-HEIGHT: 24px; FONT-SIZE: 12pt">1</span><span style="LINE-HEIGHT: 25px">。因为不同版本的</span><span style="LINE-HEIGHT: 24px; FONT-SIZE: 12pt">SD</span><span style="LINE-HEIGHT: 25px">卡操作要求有不一样的地方，所以务必查询</span><span style="LINE-HEIGHT: 24px; FONT-SIZE: 12pt">SD</span><span style="LINE-HEIGHT: 25px">卡的版本号，否则也会出现</span><span style="LINE-HEIGHT: 24px; FONT-SIZE: 12pt">SD</span><span style="LINE-HEIGHT: 25px">卡无法正常工作的问题。</span></p><br style="line-height: 25px; font-family: Arial, Helvetica, simsun, u5b8bu4f53; color: rgb(149, 149, 149); ">
<p style="line-height: 21px; text-indent: -17.85pt; margin-top: 0cm; margin-right: 0cm; margin-bottom: 0pt; margin-left: 17.85pt; font-family: Arial, Helvetica, simsun, u5b8bu4f53; color: rgb(149, 149, 149); "><span style="LINE-HEIGHT: 25px">3.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="LINE-HEIGHT: 25px">理论上要求发送</span><span style="LINE-HEIGHT: 24px; FONT-SIZE: 12pt">CMD58</span><span style="LINE-HEIGHT: 25px">获得</span><span style="LINE-HEIGHT: 24px; FONT-SIZE: 12pt">SD</span><span style="LINE-HEIGHT: 25px">卡电压参数，但实际过程中由于事先都知道了</span><span style="LINE-HEIGHT: 24px; FONT-SIZE: 12pt">SD</span><span style="LINE-HEIGHT: 25px">卡的工作电压，因此可省略这一步简化程序。协议书上也建议尽量不要用这个命令。</span></p><br style="line-height: 25px; font-family: Arial, Helvetica, simsun, u5b8bu4f53; color: rgb(149, 149, 149); ">
<p style="line-height: 21px; text-indent: -17.85pt; margin-top: 0cm; margin-right: 0cm; margin-bottom: 0pt; margin-left: 17.85pt; font-family: Arial, Helvetica, simsun, u5b8bu4f53; color: rgb(149, 149, 149); "><span style="LINE-HEIGHT: 25px">4.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="LINE-HEIGHT: 24px; FONT-SIZE: 12pt">SD</span><span style="LINE-HEIGHT: 25px">卡读写超时时间要按照协议说明书书上的给定值</span><span style="LINE-HEIGHT: 24px; FONT-SIZE: 12pt">(</span><span style="LINE-HEIGHT: 25px">读超时：</span><span style="LINE-HEIGHT: 24px; FONT-SIZE: 12pt">100ms</span><span style="LINE-HEIGHT: 25px">；写超时：</span><span style="LINE-HEIGHT: 24px; FONT-SIZE: 12pt">250ms)</span><span style="LINE-HEIGHT: 25px">，这个值要在程序中准确计算出来，否则将会出现不能正常读写数据的问题。我自己定义了一个计算公式：超时时间</span><span style="LINE-HEIGHT: 24px; FONT-SIZE: 12pt">=(</span><span style="LINE-HEIGHT: 24px; BACKGROUND-COLOR: white; FONT-SIZE: 12pt">8/clk</span><span style="LINE-HEIGHT: 24px; FONT-SIZE: 12pt">)*arg</span><span style="LINE-HEIGHT: 25px">。</span><span style="LINE-HEIGHT: 24px; FONT-SIZE: 12pt"></span></p><br style="line-height: 25px; font-family: Arial, Helvetica, simsun, u5b8bu4f53; color: rgb(149, 149, 149); ">
<p style="line-height: 21px; text-indent: -17.85pt; margin-top: 0cm; margin-right: 0cm; margin-bottom: 0pt; margin-left: 17.85pt; font-family: Arial, Helvetica, simsun, u5b8bu4f53; color: rgb(149, 149, 149); "><span style="LINE-HEIGHT: 25px">5.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="LINE-HEIGHT: 24px; FONT-SIZE: 12pt">2GB</span><span style="LINE-HEIGHT: 25px">以内的</span><span style="LINE-HEIGHT: 24px; FONT-SIZE: 12pt">SD</span><span style="LINE-HEIGHT: 25px">卡</span><span style="LINE-HEIGHT: 24px; FONT-SIZE: 12pt">(</span><span style="LINE-HEIGHT: 25px">标准卡</span><span style="LINE-HEIGHT: 24px; FONT-SIZE: 12pt">)</span><span style="LINE-HEIGHT: 25px">和</span><span style="LINE-HEIGHT: 24px; FONT-SIZE: 12pt">2GB</span><span style="LINE-HEIGHT: 25px">以上的</span><span style="LINE-HEIGHT: 24px; FONT-SIZE: 12pt">SD</span><span style="LINE-HEIGHT: 25px">卡</span><span style="LINE-HEIGHT: 24px; FONT-SIZE: 12pt">(</span><span style="LINE-HEIGHT: 25px">大容量卡</span><span style="LINE-HEIGHT: 24px; FONT-SIZE: 12pt">)</span><span style="LINE-HEIGHT: 25px">在地址访问形式上不同，这一点尤其要注意，否则将会出现无法读写数据的问题。如标准卡在读写操作时，对读或写命令令牌当中的地址域符初值</span><span style="LINE-HEIGHT: 24px; FONT-SIZE: 12pt">0x10</span><span style="LINE-HEIGHT: 25px">，表示对第</span><span style="LINE-HEIGHT: 24px; FONT-SIZE: 12pt">16</span><span style="LINE-HEIGHT: 25px">个字节以后的地址单元进行操作</span><span style="LINE-HEIGHT: 24px; FONT-SIZE: 12pt">(</span><span style="LINE-HEIGHT: 25px">前提是此</span><span style="LINE-HEIGHT: 24px; FONT-SIZE: 12pt">SD</span><span style="LINE-HEIGHT: 25px">卡支持偏移读写操作</span><span style="LINE-HEIGHT: 24px; FONT-SIZE: 12pt">)</span><span style="LINE-HEIGHT: 25px">，而对大容量卡读或写命令令牌当中的地址域符初值</span><span style="LINE-HEIGHT: 24px; FONT-SIZE: 12pt">0x10</span><span style="LINE-HEIGHT: 25px">时，则表示对第</span><span style="LINE-HEIGHT: 24px; FONT-SIZE: 12pt">16</span><span style="LINE-HEIGHT: 25px">块进行读写操作，而且大容量卡只支持块读写操作，块大小固定为</span><span style="LINE-HEIGHT: 24px; FONT-SIZE: 12pt">512</span><span style="LINE-HEIGHT: 25px">字节，对其进行字节操作将会出错。</span></p><br style="line-height: 25px; font-family: Arial, Helvetica, simsun, u5b8bu4f53; color: rgb(149, 149, 149); ">
<p style="line-height: 21px; text-indent: -17.85pt; margin-top: 0cm; margin-right: 0cm; margin-bottom: 0pt; margin-left: 17.85pt; font-family: Arial, Helvetica, simsun, u5b8bu4f53; color: rgb(149, 149, 149); "><span style="LINE-HEIGHT: 25px">6.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="LINE-HEIGHT: 25px">对某一块要进行写操作时最好先执行擦出命令，这样写入的速度就能大大提高。进行擦除操作时不管是标准卡还是大容量卡都按块操作执行，也就是一次擦除至少</span><span style="LINE-HEIGHT: 24px; FONT-SIZE: 12pt">512</span><span style="LINE-HEIGHT: 25px">字节。</span></p><br style="line-height: 25px; font-family: Arial, Helvetica, simsun, u5b8bu4f53; color: rgb(149, 149, 149); ">
<p style="line-height: 21px; text-indent: -17.85pt; margin-top: 0cm; margin-right: 0cm; margin-bottom: 0pt; margin-left: 17.85pt; font-family: Arial, Helvetica, simsun, u5b8bu4f53; color: rgb(149, 149, 149); "><span style="LINE-HEIGHT: 25px">7.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="LINE-HEIGHT: 25px">对标准卡进行字节操作时，起始和终止必须在一个物理扇区内，否则将不能进行读写操作。实际操作过程中建议用块操作以提高效率。不管是标准卡还是大容量卡一个读写命令只能对一个块进行操作，不允许跨物理层地址操作。</span></p><br style="line-height: 25px; font-family: Arial, Helvetica, simsun, u5b8bu4f53; color: rgb(149, 149, 149); ">
<p style="line-height: 21px; text-indent: -17.85pt; margin-top: 0cm; margin-right: 0cm; margin-bottom: 0pt; margin-left: 17.85pt; font-family: Arial, Helvetica, simsun, u5b8bu4f53; color: rgb(149, 149, 149); "><span style="LINE-HEIGHT: 25px">8.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="LINE-HEIGHT: 25px">在写数据块前要先写入若干个</span><span style="LINE-HEIGHT: 24px; FONT-SIZE: 12pt">dummy data</span><span style="LINE-HEIGHT: 25px">字节，写完一个块数据时，主机要监测</span><span style="LINE-HEIGHT: 24px; FONT-SIZE: 12pt">MISO</span><span style="LINE-HEIGHT: 25px">数据线，如果从机处于忙状态这根数据线会保持低电平，这样主机就可以根据这根数据线的状态以决定是否发送下一个命令，在从机没有释放</span><span style="LINE-HEIGHT: 24px; FONT-SIZE: 12pt">MISO</span><span style="LINE-HEIGHT: 25px">数据线之前，主机绝对不能执行其他命令，否则将会导致写入的数据出错，而且从机也不会响应主机的命令。</span></p><br style="line-height: 25px; font-family: Arial, Helvetica, simsun, u5b8bu4f53; color: rgb(149, 149, 149); ">
<p style="line-height: 21px; text-indent: -17.85pt; margin-top: 0cm; margin-right: 0cm; margin-bottom: 0pt; margin-left: 17.85pt; font-family: Arial, Helvetica, simsun, u5b8bu4f53; color: rgb(149, 149, 149); "><span style="LINE-HEIGHT: 25px">9.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="LINE-HEIGHT: 25px">在</span><span style="LINE-HEIGHT: 24px; FONT-SIZE: 12pt">SPI</span><span style="LINE-HEIGHT: 25px">模式下，</span><span style="LINE-HEIGHT: 24px; FONT-SIZE: 12pt">CRC</span><span style="LINE-HEIGHT: 25px">校验是被忽略的，但依然要求主从机发送</span><span style="LINE-HEIGHT: 24px; FONT-SIZE: 12pt">CRC</span><span style="LINE-HEIGHT: 25px">码，只是数值可以是任意值，一般主机的</span><span style="LINE-HEIGHT: 24px; FONT-SIZE: 12pt">CRC</span><span style="LINE-HEIGHT: 25px">码通常设为</span><span style="LINE-HEIGHT: 24px; FONT-SIZE: 12pt">0x00</span><span style="LINE-HEIGHT: 25px">或</span><span style="LINE-HEIGHT: 24px; FONT-SIZE: 12pt">0xFF</span><span style="LINE-HEIGHT: 25px">。</span></p><br style="line-height: 25px; font-family: Arial, Helvetica, simsun, u5b8bu4f53; color: rgb(149, 149, 149); ">
<p style="line-height: 25px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; font-family: Arial, Helvetica, simsun, u5b8bu4f53; color: rgb(149, 149, 149); ">读多块操作和写多块操作的传输停止形式不一样，读多块操作时用用命令CMD12终止传输，而写多块操作时用Stop 
Tran Token(停止传输令牌，值为0xFD)终止传输。</p>
<p style="line-height: 25px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; font-family: Arial, Helvetica, simsun, u5b8bu4f53; color: rgb(149, 149, 149); ">----------------------------------------------------------------------------------------</p>
<p style="line-height: 25px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; font-family: Arial, Helvetica, simsun, u5b8bu4f53; color: rgb(149, 149, 149); "><span style="FONT-FAMILY: Courier New">1、</span><span style="LINE-HEIGHT: 23px; FONT-SIZE: 12px"><br></span><span style="FONT-FAMILY: 宋体">初始化</span><span style="FONT-FAMILY: 宋体">步骤：</span><br><span style="FONT-FAMILY: Courier New">（1）</span><span style="FONT-FAMILY: Courier New"><span style="LINE-HEIGHT: 23px; FONT-SIZE: 12px">&nbsp;&nbsp;&nbsp;&nbsp;<br></span></span><span style="FONT-FAMILY: 宋体">延时至少</span><span style="FONT-FAMILY: Courier New">74clock，等待SD卡内部操作完成，在MMC协议中有明确说明。</span><br><span style="FONT-FAMILY: Courier New">（2）CS低电平选中SD卡。<br>（3）</span><span style="FONT-FAMILY: 宋体">发送</span><span style="FONT-FAMILY: Courier New">CMD0</span><span style="FONT-FAMILY: 宋体">，需要返回</span><span style="FONT-FAMILY: Courier New">0x01</span><span style="FONT-FAMILY: 宋体">，进入</span><span style="FONT-FAMILY: Courier New">Idle</span><span style="FONT-FAMILY: 宋体">状态</span><br><span style="FONT-FAMILY: Courier New">（4）</span><span style="FONT-FAMILY: 宋体">为了区别SD卡是2.0还是1.0，或是MMC卡，这里根据协议向上兼容的原理，首先发送只有<span style="COLOR: #ff6600">SD2.0才有的命令CMD8</span>，如果CMD8返回无错误，则初步判断为2.0卡，进一步发送命令循环发送</span><span style="FONT-FAMILY: Courier New">CMD55+ACMD41</span><span style="FONT-FAMILY: 宋体">，直到返回</span><span style="FONT-FAMILY: Courier New">0x00</span><span style="FONT-FAMILY: 宋体">，确定SD2.0卡初始化成功，进入<span style="FONT-FAMILY: Courier New">Ready</span>状态，再发送<span style="COLOR: #ff6600">CMD58命令来判断是HCSD还是SCSD，</span>到此SD2.0卡初始化成功。如果CMD8返回错误则进一步判断为1.0卡还是MMC卡，循环发送<span style="FONT-FAMILY: Courier New; COLOR: #ff6600">CMD55+ACMD41</span><span style="COLOR: #ff6600">，</span>返回无错误，则为SD1.0卡，到此SD1.0卡初始成功，如果在一定的循环次数下，返回为错误，则进一步发送CMD1进行初始化，如果返回无错误，则确定为MMC卡，如果在一定的次数下，返回为错误，则不能识别该卡，初始结束。</span><br><span style="FONT-FAMILY: 宋体">（5）CS拉高。</span><br><span style="FONT-FAMILY: Courier New">2、</span><span style="LINE-HEIGHT: 23px; FONT-SIZE: 12px"><br></span><span style="FONT-FAMILY: 宋体">读</span><span style="FONT-FAMILY: 宋体">步骤：</span><br><span style="FONT-FAMILY: Courier New">（1）</span><span style="FONT-FAMILY: Courier New"><span style="LINE-HEIGHT: 23px; FONT-SIZE: 12px">&nbsp;&nbsp;&nbsp;&nbsp;<br></span></span><span style="FONT-FAMILY: 宋体">发送</span><span style="FONT-FAMILY: Courier New">CMD17</span><span style="FONT-FAMILY: 宋体">（单块）或</span><span style="FONT-FAMILY: Courier New">CMD18</span><span style="FONT-FAMILY: 宋体">（多块）读命令，返回</span><span style="FONT-FAMILY: Courier New">0x00<br>（2）</span><span style="FONT-FAMILY: Courier New"><span style="LINE-HEIGHT: 23px; FONT-SIZE: 12px">&nbsp;&nbsp;&nbsp;&nbsp;<br></span></span><span style="FONT-FAMILY: 宋体">接收数据开始令牌</span><span style="FONT-FAMILY: Courier New">0xfe</span><span style="FONT-FAMILY: 宋体">（或</span><span style="FONT-FAMILY: Courier New">0xfc</span><span style="FONT-FAMILY: 宋体">）</span><span style="FONT-FAMILY: Courier New">+</span><span style="FONT-FAMILY: 宋体">正式数据</span><span style="FONT-FAMILY: Courier New">512Bytes + CRC</span><span style="FONT-FAMILY: 宋体">校验</span><span style="FONT-FAMILY: Courier New">2Bytes<br></span><span style="FONT-FAMILY: 宋体">默认正式传输的数据长度是</span><span style="FONT-FAMILY: Courier New">512Bytes</span><span style="FONT-FAMILY: 宋体">，可用</span><span style="FONT-FAMILY: Courier New">CMD16</span><span style="FONT-FAMILY: 宋体">设置块长度。</span><br><span style="FONT-FAMILY: Courier New">3、</span><span style="LINE-HEIGHT: 23px; FONT-SIZE: 12px"><br></span><span style="FONT-FAMILY: 宋体">写</span><span style="FONT-FAMILY: 宋体">步骤：</span><br><span style="FONT-FAMILY: Courier New">（1）</span><span style="FONT-FAMILY: Courier New"><span style="LINE-HEIGHT: 23px; FONT-SIZE: 12px">&nbsp;&nbsp;&nbsp;&nbsp;<br></span></span><span style="FONT-FAMILY: 宋体">发送</span><span style="FONT-FAMILY: Courier New">CMD24</span><span style="FONT-FAMILY: 宋体">（单块）或</span><span style="FONT-FAMILY: Courier New">CMD25</span><span style="FONT-FAMILY: 宋体">（多块）写命令，返回</span><span style="FONT-FAMILY: Courier New">0x00<br>（2）</span><span style="FONT-FAMILY: Courier New"><span style="LINE-HEIGHT: 23px; FONT-SIZE: 12px">&nbsp;&nbsp;&nbsp;&nbsp;<br></span></span><span style="FONT-FAMILY: 宋体">发送数据开始令牌</span><span style="FONT-FAMILY: Courier New">0xfe</span><span style="FONT-FAMILY: 宋体">（或</span><span style="FONT-FAMILY: Courier New">0xfc</span><span style="FONT-FAMILY: 宋体">）</span><span style="FONT-FAMILY: Courier New">+</span><span style="FONT-FAMILY: 宋体">正式数据</span><span style="FONT-FAMILY: Courier New">512Bytes + CRC</span><span style="FONT-FAMILY: 宋体">校验</span><span style="FONT-FAMILY: Courier New">2Bytes<br>4、</span><span style="LINE-HEIGHT: 23px; FONT-SIZE: 12px"><br></span><span style="FONT-FAMILY: 宋体">擦除</span><span style="FONT-FAMILY: 宋体">步骤：</span><br><span style="FONT-FAMILY: Courier New">（1）</span><span style="FONT-FAMILY: Courier New"><span style="LINE-HEIGHT: 23px; FONT-SIZE: 12px">&nbsp;&nbsp;&nbsp;&nbsp;<br></span></span><span style="FONT-FAMILY: 宋体">发送</span><span style="FONT-FAMILY: Courier New">CMD32</span><span style="FONT-FAMILY: 宋体">，跟一个参数来指定首个要擦除的起始地址（</span><span style="FONT-FAMILY: Courier New">SD</span><span style="FONT-FAMILY: 宋体">手册上说是块号）</span><br><span style="FONT-FAMILY: Courier New">（2）</span><span style="FONT-FAMILY: Courier New"><span style="LINE-HEIGHT: 23px; FONT-SIZE: 12px">&nbsp;&nbsp;&nbsp;&nbsp;<br></span></span><span style="FONT-FAMILY: 宋体">发送</span><span style="FONT-FAMILY: Courier New">CMD33,</span><span style="FONT-FAMILY: 宋体">，指定最后的地址</span><br><span style="FONT-FAMILY: Courier New">（3）</span><span style="FONT-FAMILY: Courier New"><span style="LINE-HEIGHT: 23px; FONT-SIZE: 12px">&nbsp;&nbsp;&nbsp;&nbsp;<br></span></span><span style="FONT-FAMILY: 宋体">发送</span><span style="FONT-FAMILY: Courier New">CMD38</span><span style="FONT-FAMILY: 宋体">，擦除指定区间的内容</span><br><span style="FONT-FAMILY: 宋体">此</span><span style="FONT-FAMILY: Courier New">3</span><span style="FONT-FAMILY: 宋体">步顺序不能颠倒。</span><br><span style="FONT-FAMILY: 宋体">最后说一下我的一点体会：SD卡就是一个存储器，只不过用命令的方式来进行操作，我们只要掌握了各条命令及操作方式，就可以灵活的操作SD卡了，另外我所了解的IC卡也是类似的原理，还有就是建议开始看MMC的协议，简单明了易懂些，有了对MMC卡的一些了解后看SD卡协议就容易多了。</span></p>
<p style="line-height: 25px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; font-family: Arial, Helvetica, simsun, u5b8bu4f53; color: rgb(149, 149, 149); "><strong><span style="COLOR: #ff0000"></span></strong>&nbsp;</p><strong><span style="COLOR: #ff0000"></span></strong>
<p>（1）图中的Y轴坐标表示SD卡支持的电压，一般都是2.7-3.6v之间。X轴为时间坐标。<br>（2）power up time阶段：</p>
<p>&nbsp;&nbsp;&nbsp; 这段时间为插上SD卡，到sd卡的的供电电压达到最低要求电压的这段时间。这个时候sd 
clock还没正常提供，处于禁止状态，Linux在这段时间内delay 10ms。</p>
<p>（3）supply ramp up time阶段：</p>
<p>&nbsp; （2）（3）阶段时间段，对应Linux mmc子系统的codes为：</p>
<p><br>/*</p>
<p>* Apply power to the MMC stack.&nbsp; This is a two-stage process.</p>
<p>* First, we enable power to the card without the clock running.</p>
<p>* We then wait a bit for the power to stabilise.&nbsp; Finally,</p>
<p>* enable the bus drivers and clock to the card.</p>
<p>*</p>
<p>* We must _NOT_ enable the clock prior to power stablising.</p>
<p>*</p>
<p>* If a host does all the power sequencing itself, ignore the</p>
<p>* initial <a name="baidusnap0"></a><b style="color:black;background-color:#ffff66">MMC_POWER_UP</b> stage.</p>
<p>*/</p>
<p>static void <b style="color:black;background-color:#ffff66">mmc_power_up</b>(struct mmc_host *host)</p>
<p>{</p>
<p>int bit;</p>
<p>/* If ocr is set, we use it */</p>
<p>if (host-&gt;ocr)</p>
<p>&nbsp; bit = ffs(host-&gt;ocr) - 1;</p>
<p>else</p>
<p>&nbsp; bit = fls(host-&gt;ocr_avail) - 1;</p>
<p>host-&gt;ios.vdd = bit;</p>
<p>if (mmc_host_is_spi(host)) {</p>
<p>&nbsp; host-&gt;ios.chip_select = MMC_CS_HIGH;</p>
<p>&nbsp; host-&gt;ios.bus_mode = MMC_BUSMODE_PUSHPULL;</p>
<p>} else {</p>
<p>&nbsp; host-&gt;ios.chip_select = MMC_CS_DONTCARE;</p>
<p>&nbsp; host-&gt;ios.bus_mode = MMC_BUSMODE_OPENDRAIN;</p>
<p>}</p>
<p>host-&gt;ios.power_mode = <b style="color:black;background-color:#ffff66">MMC_POWER_UP</b>;</p>
<p>host-&gt;ios.bus_width = MMC_BUS_WIDTH_1;</p>
<p>host-&gt;ios.timing = MMC_TIMING_LEGACY;</p>
<p>mmc_set_ios(host);//这段code被调用之前，为状态（2）power up 
time时间段，这段时间内host-&gt;ios.clock被设置为0.</p>
<p>/*</p>
<p>&nbsp; * This delay should be sufficient to allow the power supply</p>
<p>&nbsp; * to reach the minimum voltage.</p>
<p>&nbsp; */</p>
<p>mmc_delay(10);</p>
<p>host-&gt;ios.clock = host-&gt;f_init;</p>
<p>host-&gt;ios.power_mode = MMC_POWER_ON;</p>
<p>mmc_set_ios(host);//这段code之前属于supply ramp up 
time阶段，这段时间内host-&gt;ios.clock被设置为最小值，我们在驱动中会设置这个值，这个值应该小于等于400KHZ.</p>
<p>/*</p>
<p>&nbsp; * This delay must be at least 74 clock sizes, or 1 ms, or the</p>
<p>&nbsp; * time required to reach a stable voltage.</p>
<p>&nbsp; */</p>
<p>mmc_delay(10);//这个延时是等sd 
host给出74个clocks。74个clocks期间CMD线拉高，这个时候不能发送任何命令给SD卡。这个延时过后，系统就可以发送命令给sd 
card了。</p>
<p>}</p>
<p>（4）CMD0阶段</p>
<p>对应linux驱动中的code为：</p>
<p><br>int mmc_go_idle(struct mmc_host *host)</p>
<p>{</p>
<p>int err;</p>
<p>struct mmc_command cmd;</p>
<p>/*</p>
<p>&nbsp;* Non-SPI hosts need to prevent chipselect going active during</p>
<p>&nbsp;* GO_IDLE; that would put chips into SPI mode.&nbsp; Remind them of</p>
<p>&nbsp;* that in case of hardware that won't pull up DAT3/nCS otherwise.</p>
<p>&nbsp;*</p>
<p>&nbsp;* SPI hosts ignore ios.chip_select; it's managed according to</p>
<p>&nbsp;* rules that must accomodate non-MMC slaves which this layer</p>
<p>&nbsp;* won't even know about.</p>
<p>&nbsp;*/</p>
<p>#if 0</p>
<p>if (!mmc_host_is_spi(host)) {</p>
<p>&nbsp; mmc_set_chip_select(host, MMC_CS_HIGH);</p>
<p>&nbsp; mmc_delay(1);</p>
<p>}</p>
<p>#endif</p>
<p>memset(&amp;cmd, 0, sizeof(struct mmc_command));</p>
<p>cmd.opcode = MMC_GO_IDLE_STATE;</p>
<p>cmd.arg = 0;</p>
<p>cmd.flags = MMC_RSP_SPI_R1 | MMC_RSP_NONE | MMC_CMD_BC;</p>
<p>err = mmc_wait_for_cmd(host, &amp;cmd, 0);</p>
<p>mmc_delay(1);</p>
<p>if (!mmc_host_is_spi(host)) {</p>
<p>&nbsp; mmc_set_chip_select(host, MMC_CS_DONTCARE);</p>
<p>&nbsp; mmc_delay(1);</p>
<p>}</p>
<p>host-&gt;use_spi_crc = 0;</p>
<p>return err;</p>
<p>}</p>
<p>这段时间sd进入idle状态。</p>
<p>（5）CMD8阶段</p>
<p>sd host发送cmd8来check sd host端支持的电压 
host-&gt;ocr_avail是否被sd卡支持，如果sd支持的话那么在cmd8的response中会返回这些支持的值，并且返回写入cmd8命令中的test_pattern值。否则就表示不支持sd 
host的电压范围。对应的linux mmc驱动代码为：</p>
<p><br>int mmc_send_if_cond(struct mmc_host *host, u32 ocr)</p>
<p>{</p>
<p>struct mmc_command cmd;</p>
<p>int err;</p>
<p>static const u8 test_pattern = 0xAA;</p>
<p>u8 result_pattern;</p>
<p>/*</p>
<p>&nbsp; * To support SD 2.0 cards, we must always invoke SD_SEND_IF_COND</p>
<p>&nbsp; * before SD_APP_OP_COND. This command will harmlessly fail for</p>
<p>&nbsp; * SD 1.0 cards.</p>
<p>&nbsp; */</p>
<p>cmd.opcode = SD_SEND_IF_COND;</p>
<p>cmd.arg = ((ocr &amp; 0xFF8000) != 0) &lt;&lt; 8 | test_pattern;</p>
<p>cmd.flags = MMC_RSP_SPI_R7 | MMC_RSP_R7 | MMC_CMD_BCR;</p>
<p>err = mmc_wait_for_cmd(host, &amp;cmd, 0);</p>
<p>if (err)</p>
<p>&nbsp; return err;</p>
<p>if (mmc_host_is_spi(host))</p>
<p>&nbsp; result_pattern = cmd.resp[1] &amp; 0xFF;</p>
<p>else</p>
<p>&nbsp; result_pattern = cmd.resp[0] &amp; 0xFF;</p>
<p>if (result_pattern != test_pattern)</p>
<p>&nbsp; return -EIO;</p>
<p>return 0;</p>
<p>}</p>
<p>&nbsp;</p>
<p>（6） ACMD41阶段</p>
<p>(1)这个阶段设置ACMD41的参数OCR=0，为了去获得SD卡自身支持的电压范围值。然后与 host-&gt;ocr_avail，SD 
host所能支持的电压范围取交集，如果交集为空，则返回匹配失败。</p>
<p><br>int mmc_send_app_op_cond(struct mmc_host *host, u32 ocr, u32 *rocr)</p>
<p>{</p>
<p>struct mmc_command cmd;</p>
<p>int i, err = 0;</p>
<p>BUG_ON(!host);</p>
<p>memset(&amp;cmd, 0, sizeof(struct mmc_command));</p>
<p>cmd.opcode = SD_APP_OP_COND;</p>
<p>if (mmc_host_is_spi(host))</p>
<p>&nbsp;cmd.arg = ocr &amp; (1 &lt;&lt; 30); /* SPI only defines one bit */</p>
<p>else</p>
<p>&nbsp; cmd.arg = ocr;</p>
<p>cmd.flags = MMC_RSP_SPI_R1 | MMC_RSP_R3 | MMC_CMD_BCR;</p>
<p>for (i = 100; i; i--) {</p>
<p>&nbsp; err = mmc_wait_for_app_cmd(host, NULL, &amp;cmd, MMC_CMD_RETRIES);</p>
<p>&nbsp; if (err)</p>
<p>&nbsp;&nbsp; break;</p>
<p>&nbsp; /* if we're just probing, do a single pass */</p>
<p>&nbsp; if (ocr == 0)</p>
<p>&nbsp;&nbsp; break;</p>
<p>&nbsp; /* otherwise wait until reset completes */</p>
<p>&nbsp; if (mmc_host_is_spi(host)) {</p>
<p>&nbsp;&nbsp; if (!(cmd.resp[0] &amp; R1_SPI_IDLE))</p>
<p>&nbsp;&nbsp;&nbsp; break;</p>
<p>&nbsp; } else {</p>
<p>&nbsp;&nbsp; if (cmd.resp[0] &amp; MMC_CARD_BUSY)</p>
<p>&nbsp;&nbsp;&nbsp; break;</p>
<p>&nbsp; }</p>
<p>&nbsp; err = -ETIMEDOUT;</p>
<p>&nbsp; mmc_delay(10);</p>
<p>}</p>
<p>if (rocr &amp;&amp; !mmc_host_is_spi(host))</p>
<p>&nbsp; *rocr = cmd.resp[0];</p>
<p>return err;</p>
<p>}</p>
<p>(7) CMD2阶段</p>
<p>通过这个命令或者所有SD卡的 Menufacory id ，Product id等卡的信息。</p>
<p><br>int mmc_all_send_cid(struct mmc_host *host, u32 *cid)</p>
<p>{</p>
<p>int err;</p>
<p>struct mmc_command cmd;</p>
<p>BUG_ON(!host);</p>
<p>BUG_ON(!cid);</p>
<p>memset(&amp;cmd, 0, sizeof(struct mmc_command));</p>
<p>cmd.opcode = MMC_ALL_SEND_CID;</p>
<p>cmd.arg = 0;</p>
<p>cmd.flags = MMC_RSP_R2 | MMC_CMD_BCR;</p>
<p>err = mmc_wait_for_cmd(host, &amp;cmd, MMC_CMD_RETRIES);</p>
<p>if (err)</p>
<p>&nbsp;return err;</p>
<p>memcpy(cid, cmd.resp, sizeof(u32) * 4);</p>
<p>return 0;</p>
<p>}</p>
<p>（8）CMD3取得卡的相对地址，进入数据传输模式，点对点的传输。</p>
<p><br>int mmc_send_relative_addr(struct mmc_host *host, unsigned int *rca)</p>
<p>{</p>
<p>int err;</p>
<p>struct mmc_command cmd;</p>
<p>BUG_ON(!host);</p>
<p>BUG_ON(!rca);</p>
<p>memset(&amp;cmd, 0, sizeof(struct mmc_command));</p>
<p>cmd.opcode = SD_SEND_RELATIVE_ADDR;</p>
<p>cmd.arg = 0;</p>
<p>cmd.flags = MMC_RSP_R6 | MMC_CMD_BCR;</p>
<p>err = mmc_wait_for_cmd(host, &amp;cmd, MMC_CMD_RETRIES);</p>
<p>if (err)</p>
<p>&nbsp; return err;</p>
<p>*rca = cmd.resp[0] &gt;&gt; 16;</p>
<p>return 0;</p>
<p>}<br></p></div></td>
                                                                                    </tr>
                                                                                </tbody>
                                                                            </table>
                                                                            <div id="viewerPlaceHolder" style="width: 717px; height: 700px; display: none;">
                                                                            </div>

                                                                        </span>
                                                                        <table>
                                                                            <tbody>
                                                                                <tr>
                                                                                    <td></td>
                                                                                </tr>
                                                                            </tbody>
                                                                        </table>
                                                                    </td>
                                                                </tr>
                                                                <tr>
                                                                    <td>
                                                                        <div class="left list" style="text-align: left; font-size: 14px;">
                                                                            <div id="lastart"></div>
                                                                            <div id="nextart"></div>
                                                                        </div>
                                                                    </td>
                                                                </tr>
                                                                <tr>
                                                                    <td style="height: 29px;">
                                                                        <div style="padding-top: 20px;">
                                                                            <table style="width: 100%;" cellpadding="0" cellspacing="0">
                                                                                <tbody>
                                                                                    <tr>
                                                                                        <td width="31%"></td>
                                                                                        <td>
                                                                                            <table cellpadding="0" cellspacing="0" style="margin: 0px auto;">
                                                                                                <tbody>
                                                                                                    <tr>
                                                                                                        <td><div class=" left" style="cursor: pointer">
                                                                                                                    <a href="javascript:void(0);" onclick="wzhit(22);SaveArt();">
                                                                                                                        <img src="./SD卡操作_files/tb11.gif"></a>
                                                                                                                </div>

                                                                                                            <div class=" left xianhua" id="sendFlowerToUser" style="cursor: pointer" onclick="Showflowerlayer(&quot;sendedLayer1&quot;);">
                                                                                                                献花(<span id="articleflowernum">0</span>)<div id="flowernumadd" class="addtionone">+1</div>
                                                                                                            </div>

                                                                                                             

                                       
                                                                                                        </td>
                                                                                                    </tr>
                                                                                                </tbody>
                                                                                            </table>
                                                                                        </td>
                                                                                        <td width="31%" style="vertical-align: bottom; font-size: 12px;">
                                                                                            <div class="right" id="sharediv2">
                                                                                            </div>

                                                                                        </td>
                                                                                    </tr>
                                                                                </tbody>
                                                                            </table>



                                                                        </div>
                                                                    </td>
                                                                </tr>

                                                                <tr>
                                                                    <td>
                                                                        <div class="xiantao" style="padding-top: 5px;">
                                                                        </div>
                                                                    </td>
                                                                </tr>
                                                                <tr>
                                                                    <td class="xgiambox" style="vertical-align: top; height: 30px; padding-top: 10px;">
                                                                        <div class="right">(本文系<span class="name"><a target="_blank" href="http://www.360doc.com/userhome/6973384">cz81</a></span>首藏<span id="docsource"></span>)</div>
                                                                    </td>
                                                                </tr>
                                                            </tbody>
                                                        </table>
                                                    </td>
                                                </tr>

                                            </tbody>
                                        </table>


                                    </td>
                                </tr>
                            </tbody>
                        </table>
                        <div class="lswzbox">
                            <div>
                                <table cellpadding="0" cellspacing="0">
                                    <tbody>
                                        <tr>
                                            <td>
                                                  <div class="bottom_article f_left">
                        <div class="str_border">
                            <strong>类似文章</strong>
                            <a href="http://www.360doc.com/relevant/275679840_more.shtml" target="_blank" class="a_more f_right" onclick="artStatistics(&quot;20-9-8&quot;);">更多</a>
                        </div>
                        <ul class="barticle_list">
                            
                                    <li><span><a href="http://www.360doc.com/content/11/0830/17/3038654_144546308.shtml" target="_blank" onclick="artStatistics(&quot;20-9-7&quot;);">linux设备驱动那点事儿之SD卡驱动理论篇...</a></span></li>
                                
                                    <li><span><a href="http://www.360doc.com/content/15/0203/13/7821691_445938642.shtml" target="_blank" onclick="artStatistics(&quot;20-9-7&quot;);">SD/MMC插口的规范之二：软件命令</a></span></li>
                                
                                    <li><span><a href="http://www.360doc.com/content/17/0724/19/15700426_673832169.shtml" target="_blank" onclick="artStatistics(&quot;20-9-7&quot;);">SD Card 驱动流程分析</a></span></li>
                                
                                    <li><span><a href="http://www.360doc.com/content/15/0420/01/12109864_464498499.shtml" target="_blank" onclick="artStatistics(&quot;20-9-7&quot;);">STM32 SDIO方式驱动SD卡之SD协议</a></span></li>
                                
                                    <li><span><a href="http://www.360doc.com/content/12/1003/23/9298584_239362343.shtml" target="_blank" onclick="artStatistics(&quot;20-9-7&quot;);">SDIO架构初解</a></span></li>
                                
                                    <li><span><a href="http://www.360doc.com/content/12/0512/12/9400799_210488663.shtml" target="_blank" onclick="artStatistics(&quot;20-9-7&quot;);">linux sd卡驱动分析，基于mini2440，sdi...</a></span></li>
                                
                                    <li><span><a href="http://www.360doc.com/content/18/0406/15/32862269_743310927.shtml" target="_blank" onclick="artStatistics(&quot;20-9-7&quot;);">linux内核mmc读写分析</a></span></li>
                                
                                    <li><span><a href="http://www.360doc.com/content/20/0719/12/68538116_925300904.shtml" target="_blank" onclick="artStatistics(&quot;20-9-7&quot;);">emmc、Nand flash、Nor flash之间的区别...</a></span></li>
                                
                        </ul>
                    </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>




                                <div id="Reflction">
                                    <div id="360docRefTN">
                                    </div>
                                    <div id="360docRefCT">
                                    </div>
                                    <div id="360docRefPB" align="center">
                                    </div>
                                </div>
                                <a name="sf"></a>




                                <div id="ReflectionPart">

                                    <div class="mainbottom">
                                        <div class=" left">
                                            <img src="./SD卡操作_files/tb22.gif">
                                        </div>
                                        <div class="plbox left">
                                            <div class="plmain">
                                                <div class="titwx">发表评论：</div>
                                                <div>
                                                    <textarea name="SendRefTB" class="pltxt" id="SendRefTB" onfocus="testContent(1);" onblur="testContent(2)"></textarea>
                                                </div>
                                                <div class="right">
                                                    <img id="ImgSendPL" src="./SD卡操作_files/tb24.gif" style="cursor: pointer;" onclick="SubmitReflection()" width="75" height="28">
                                                </div>
                                            </div>
                                        </div>
                                        <div class=" left">
                                            <img src="./SD卡操作_files/tb23.gif">
                                        </div>
                                    </div>


                                </div>

                            </div>
                        </div>





                    </td>
                    <td align="center" valign="top" width="18px"></td>
                    <td align="left" valign="top" width="252px"></td>
                </tr>
            </tbody>
        </table>
    </div>

    
    <span id="LayerLogin"></span>
    
    

    
    
    



</div>



</body></html>